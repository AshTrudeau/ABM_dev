---
title: "Vilas VBGF"
output: html_document
date: "2023-10-30"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(wdnr.fmdb, tidyverse, here, lubridate, broom, FSA, halk)
```

Producing VBGF parameters for walleye, lmb, bluegill in each sampled lake in Vilas county.
Fill in other lakes with class-specific VBGF params  from Rypel. 

Pull length age data

```{r}
length.age.vilas<-get_fmdb_lenage(county="vilas")%>%
  filter(species%in%c("walleye"))%>%
  select(species, county, wbic, year, age, length)%>%
  dplyr::rename("spp"=species,
                "waterbody"=wbic)

vilas.halk<-make_halk(length.age.vilas, levels=c("spp","county","year","waterbody"), plus_group=15, min_age=1)

#test.lake<-filter(length.age.vilas, wbic==1545600 & species=="walleye" & sex=="f")
```

But that gives probability of age given length, not probability of length given age. I'll have to go into the data itself

```{r}
# data check
dataCheck<-length.age.vilas%>%
  filter(!is.na(age))%>%
  group_by(waterbody, year)%>%
  dplyr::summarize(n.age=length(unique(age)),
            n.length=length(unique(as.integer(length))),
            n.samples=n())%>%
  ungroup()%>%
  filter(n.age>5,
         n.length>5,
         n.samples>5)

inv.key.nAge<-length.age.vilas%>%
  filter(!is.na(age))%>%
  dplyr::filter(waterbody%in%dataCheck$waterbody & year%in%dataCheck$year)%>%
  dplyr::mutate(length.int=as.integer(length))%>%
  dplyr::group_by(waterbody, year, age)%>%
  dplyr::summarize(nAge=n())%>%
  ungroup()

inv.key.nLength<-length.age.vilas%>%
  filter(!is.na(age))%>%
  dplyr::filter(waterbody%in%dataCheck$waterbody & year%in%dataCheck$year)%>%
  dplyr::mutate(length.int=as.integer(length))%>%
  dplyr::group_by(waterbody, year, length.int)%>%
  dplyr::summarize(nLength=n())%>%
  ungroup()

  
```

I can't do this right now. come back to it with a fresh brain.


Going to use least squares to fit VBGF for each lake and species

```{r}
vbgf<-function(age, Linf, k, t0){
  length=Linf*(1-exp(-k*(age-t0)))
}


vb.start<-c(Linf=40, k=0.05, t0=-3)

vb.fit<-nls(length~vbgf(age, Linf, k, t0), data=test.lake, start=vb.start)

coef(vb.fit)
```
use purrr to apply across all lakes

```{r}
walleye.df<-filter(length.age.vilas, species=="walleye" & !is.na(age))

fit.vbgf<-function(.data, .start){
  nls(length=Linf*(1-exp(-k*(age-t0))), data=.data, start=.start)
}

# vaguely fine starting values
vb.start<-c(Linf=40, k=0.05, t0=-3)

# fit by lake and year, but check for at least 10 individuals and 5 age classes

check.samples<-walleye.df%>%
  group_by(wbic, year)%>%
  summarize(n=n(),
            nAges=length(unique(age)))%>%
  filter(n>9 & nAges>5)%>%
  mutate(wbic_year=paste(wbic, year, sep="_"))%>%
  ungroup()

walleye.df.f<-walleye.df%>%
  mutate(wbic_year=paste(wbic, year, sep="_"))%>%
  filter(wbic_year%in%check.samples$wbic_year)

possibly.vbStarts<-possibly(.f=vbStarts, otherwise=NA)
possibly.nls<-possibly(.f=nls, otherwise=NA)

# try getting starting values first


walleye.start<-walleye.df.f%>%
  group_by(wbic, year)%>%
  nest()%>%
  mutate(start=map(data, ~possibly.vbStarts(length~age, data=.)))%>%
  select(wbic, year, start)%>%
  ungroup()

df.start<- ldply(walleye.start$start, data.frame)


walleye.start.df<-cbind.data.frame(walleye.start$wbic, walleye.start$year, df.start)%>%
  dplyr::rename("wbic"=`walleye.start$wbic`,
         "year"=`walleye.start$year`,
         "k"=K)%>%
  mutate(problem=ifelse(Linf<15 | Linf>50 | k<0 | is.nan(t0), 1, 0))%>%
  mutate(Linf=ifelse(problem==1, 40, Linf),
         k=ifelse(problem==1, 0.05, k),
         t0=ifelse(problem==1, -3, t0))%>%
  dplyr::rename("start.Linf"=Linf,
         "start.k"=k,
         "start.t0"=t0)
   
# next join starting values to walleye.df.f, use those in vbgf fit instead of just generic starting values

walleye.vbgf<-walleye.df.f%>%
  filter(wbic%in%check.samples$wbic & year%in%check.samples$year)%>%
  mutate(start.Linf=40,
         start.k=0.05,
         start.t0=-3)%>%
  group_by(wbic, year)%>%
  nest()%>%
  mutate(fit=map(data, ~possibly.nls(length~Linf*(1-exp(-k*(age-t0))), 
                            data=.,
                            start=c(Linf=unique(.$start.Linf),
                                    k=unique(.$start.k),
                                    t0=unique(.$start.t0)),
                            nls.control(maxiter=500))))

vbgf.fits.agg<-walleye.vbgf%>%
  filter(!is.na(fit))%>%
  mutate(coef=map(fit, coef))%>%
  ungroup()

df<-as.data.frame(do.call(rbind, vbgf.fits.agg$coef))  

vbgf.df.agg<-cbind.data.frame(vbgf.fits.agg$wbic, vbgf.fits.agg$year, df)
write.csv(vbgf.df.agg, here::here("data","fmdb.vbgf.status.csv"))

vbgf.fails<-walleye.vbgf%>%
  filter(is.na(fit))

for(i in 1:nrow(vbgf.fails)){
  print(ggplot(as.data.frame(vbgf.fails[[i,3]]))+
          geom_point(aes(x=age, y=length)))
}
```


```{r}
# sex check

sex.n<-walleye.df%>%
  filter(!is.na(sex) & sex!="u")%>%
  group_by(wbic, sex)%>%
  summarize(n=n(),
            nAges=length(unique(age)))%>%
  ungroup()%>%
  mutate(enough=ifelse(n>10 &))
  group_by(wbic)%>%
  summarize(enough=ifelse(sum(n)>10 &,1,0))%>%
  filter(enough==1)

sex.n.both<-walleye.df%>%
  filter(!is.na(sex) &  sex!="u")%>%
  filter(wbic%in%sex.n$wbic)%>%
  group_by(wbic, sex)%>%
  summarize(n=n())%>%
# I see only 1 lake remaining with not enough sex-specific observations
  filter(wbic!=	2956700)
  

possibly.nls<-possibly(.f=nls, otherwise=NA)

walleye.vbgf.sex<-walleye.df%>%
  filter(wbic%in%sex.n.both$wbic)%>%
  filter(!is.na(sex) & sex!="u")%>%
  mutate(start.Linf=40,
         start.k=0.05,
         start.t0=-3)%>%
  group_by(wbic, sex)%>%
  nest()%>%
  mutate(fit=map(data, ~possibly.nls(length~Linf*(1-exp(-k*(age-t0))), 
                            data=.,
                            start=c(Linf=unique(.$start.Linf),
                                    k=unique(.$start.k),
                                    t0=unique(.$start.t0)),
                            nls.control(maxiter=500))))

vbgf.fits.sex<-walleye.vbgf.sex%>%
  filter(!is.na(fit))%>%
  mutate(coef=map(fit, coef))%>%
  ungroup()

df<-as.data.frame(do.call(rbind, vbgf.fits.sex$coef))  

vbgf.df.sex<-cbind.data.frame(vbgf.fits.sex$wbic, vbgf.fits.sex$sex, df)

# these are our successful sex-specific VBGF fits
names(vbgf.df.sex)<-c("wbic","sex","Linf","k","t0")
write.csv(vbgf.df.sex, here::here("data","sex.specific.vilas.vbgf.csv"))

# now for all samples, with sexes lumped together

walleye.vbgf.lump<-walleye.df%>%
  filter(!is.na(age))%>%
  mutate(start.Linf=40,
         start.k=0.05,
         start.t0=-3)%>%
  group_by(wbic)%>%
  nest()%>%
  mutate(fit=map(data, ~possibly.nls(length~Linf*(1-exp(-k*(age-t0))), 
                            data=.,
                            start=c(Linf=unique(.$start.Linf),
                                    k=unique(.$start.k),
                                    t0=unique(.$start.t0)),
                            nls.control(maxiter=500))))

vbgf.fits.lump<-walleye.vbgf.lump%>%
  filter(!is.na(fit))%>%
  mutate(coef=map(fit, coef))%>%
  ungroup()

df<-as.data.frame(do.call(rbind, vbgf.fits.lump$coef))  

vbgf.df.lump<-cbind.data.frame(vbgf.fits.lump$wbic,  df)
names(vbgf.df.lump)<-c("wbic","Linf","k","t0")

write.csv(vbgf.df.lump, here::here("data","aggregate.vilas.vbgf.csv"))


# so which lakes don't have any estimate?
```

```{r}
lake.status<-length.age.vilas%>%
  group_by(wbic)%>%
  summarize(nYears=length(unique(year)),
            minYear=min(year),
            maxYear=max(year))%>%
  mutate(sexSpecificGrowth=ifelse(wbic%in%vbgf.df.sex$wbic, 1, 0),
            aggGrowth=ifelse(wbic%in%vbgf.df.lump$wbic, 1, 0))%>%
  ungroup()

write.csv(lake.status, here::here("data","fmdb.vbgf.status.csv"))
```

Making age-length keys

```{r}
vbgf<-function(age, Linf, k, t0){
  length=Linf*(1-exp(-k*(age-t0)))
}

ages<-c(1:15)

# ages 1 to 15 for walleye
walleye.key.agg<-lake.status%>%
  filter(aggGrowth==1)%>%
  select(wbic)%>%
  # repeat each row 15 times
  slice(rep(1:n(), each = 15))%>%
  mutate(age=rep(ages, 70))%>%
  # join on parameters
  left_join(vbgf.df.lump, by="wbic")%>%
  mutate(length=vbgf(age, Linf, k, t0))

ggplot(walleye.key.agg)+
  geom_line(aes(x=age, y=length, color=as.factor(wbic)))+
  theme(legend.position="none")
# two of those  look wonky


```

```{r}
walleye.key.sex<-lake.status%>%
  filter(sexSpecificGrowth==1)%>%
  select(wbic)%>%
  # repeat each row 15 times
  slice(rep(1:n(), each = 15))%>%
  mutate(age=rep(ages, 70))%>%
  # join on parameters
  left_join(vbgf.df.sex, by="wbic")%>%
  mutate(length=vbgf(age, Linf, k, t0))

ggplot(walleye.key.sex)+
  geom_line(aes(x=age, y=length, color=as.factor(wbic)))+
  theme(legend.position="none")+
  facet_grid(.~sex)
# severl lakes with very negative lengths at low ages, one lake with very high linf

problems<-walleye.key.sex%>%
  filter(length<0 | length>35)

`%!in%`<-Negate(`%in%`)
walleye.key.sex.f<-filter(walleye.key.sex, wbic%!in%problems$wbic)

ggplot(walleye.key.sex.f)+
  geom_line(aes(x=age, y=length, color=as.factor(wbic)))+
  facet_grid(.~sex)+
  theme(legend.position="none")

# better



```
Now bring in lake class keys; go w ith 50th percentile estimate for now

```{r}
class.key.50<-read_csv(here::here("data","lake class standards", "Lake Class Standards Von Bert.csv"))%>%
  filter(Species=="Walleye")%>%
  pivot_wider(names_from=vb_param,
              values_from=value
              )
```

